name: CI

on: [push]

jobs:
  build:
    runs-on: ubuntu-latest
    container:
      image: ubuntu:latest
      env:
        DEBIAN_FRONTEND: noninteractive
        TZ: Europe/Paris
    steps:
      - uses: actions/checkout@v3
      - name: Install dependencies
        run: |
          apt-get update;apt-get upgrade -y
          apt-get install -y python3-pip
          update-alternatives --install /usr/bin/python python /usr/bin/python3 1
          apt-get install -y libguestfs-tools python3-guestfs
          apt-get install -y python3-tk
          python -m pip install --upgrade pip
          pip install -r requirements.txt
      - name: Set time zone
        run: |
          apt-get update
          apt-get install -y tzdata
          ln -fs /usr/share/zoneinfo/Europe/Paris /etc/localtime
          dpkg-reconfigure -f noninteractive tzdata
          
      - name: Run tests
        run: |
          python VSA/manage.py test ovs_conf  -v 2
      - name: Update required status checks
        uses: actions/github-script@0.9.1
        with:
          script: |
            const github = require('@actions/github');
            const { owner, repo } = github.context.repo;
            const branch = github.context.ref;
            await github.branch_protection.update_required_status_checks({
              owner,
              repo,
              branch,
              required_status_checks: {
                strict: true,
                contexts: ['ci/build']
              }
            });
      - name: Push changes to main branch
        if: github.event_name == 'push' && github.ref == 'refs/heads/main'
        uses: actions/git-toolkit-actions@1.1.1
        with:
          action: 'push'
          branch: main
          message: 'Update main branch'
   
